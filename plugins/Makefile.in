CXX=@CXX@
CXXFLAGS=@CXXFLAGS@
CXXFLAGS+=-fPIC -I../include -I../
DEFS=@DEFS@
LDFLAGS=@LDFLAGS@ @LIBS@

PREFIX=@prefix@
prefix=@prefix@
exec_prefix=@exec_prefix@
LIBDIR=@libdir@

HAVE_IP4TCP=@have_ip4tcp@
HAVE_IP6TCP=@have_ip6tcp@
HAVE_NOTIFY=@have_notify@
LIBNOTIFY_VERSION=@libnotify_version@
HAVE_AVAHI=@have_avahi@
HAVE_DBUS=@have_dbus@

DBUS_CFLAGS=@DBUS_CFLAGS@
DBUS_LIBS=@DBUS_LIBS@

AVAHI_CFLAGS=@AVAHI_CFLAGS@
AVAHI_LIBS=@AVAHI_LIBS@

HOST=@host_alias@

ifeq ($(LIBNOTIFY_VERSION),4)
	NOTIFY_CFLAGS=@LIBNOTIFY4_CFLAGS@
	NOTIFY_LIBS=@LIBNOTIFY4_LIBS@
endif

ifeq ($(LIBNOTIFY_VERSION),1)
	NOTIFY_CFLAGS=@LIBNOTIFY1_CFLAGS@
	NOTIFY_LIBS=@LIBNOTIFY1_LIBS@
endif

ALL=

ifeq ($(HAVE_IP4TCP),yes)
	ALL+=ip4tcp$(EXTENSION)
endif

ifeq ($(HAVE_IP6TCP),yes)
	ALL+=ip6tcp$(EXTENSION)
endif

ifeq ($(HAVE_NOTIFY),yes)
	ALL+=desktop-notify$(EXTENSION)
endif

ifeq ($(HAVE_DBUS),yes)
	ALL+=dbus$(EXTENSION)
endif

ifeq ($(HAVE_AVAHI),yes)
	ALL+=avahi-publish$(EXTENSION)
endif

ifeq ($(HOST),i686-linux-gnu)
	CXXFLAGS+=-march=i686 -m32
	OS=linux
	ARCH=i686
endif

ifeq ($(HOST),i686-w64-mingw32)
	OS=windows
	ARCH=i686
endif

ifeq ($(HOST),x86_64-w64-mingw32)
	OS=windows
	ARCH=x86_64
endif

OS ?= linux

ifeq ($(OS),linux)
	LDFLAGS+=-ldl -pthread -rdynamic -shared
	EXTENSION=.so
endif

ifeq ($(OS),windows)
#	CXXFLAGS+=-mdll
	LDFLAGS+=-shared
	DEFS+=-DWINDOWS
	EXTENSION=.dll
	DLLTOOL=$(HOST)-dlltool
endif

all: $(ALL)

../src/libinstantsend-plugin.dll:
	$(MAKE) -C ../src libinstantsend-plugin.dll

../src/libinstantsend-json.dll:
	$(MAKE) -C ../src libinstantsend-json.dll

ip4tcp.so: ../include/pluginapi.h ip4tcp.cpp
	 $(CXX) $(CXXFLAGS) $(DEFS) -o $@ ip4tcp.cpp $(LDFLAGS)

ip4tcp-windows.o: ../include/pluginapi.h ip4tcp-windows.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ ip4tcp-windows.cpp

ip4tcp.dll: ip4tcp-windows.o ../src/libinstantsend-plugin.dll ../src/libinstantsend-json.dll
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ ip4tcp-windows.o -L../src/ -linstantsend-json -linstantsend-plugin -lwsock32 $(LDFLAGS)

ip6tcp-windows.o: ../include/pluginapi.h ip6tcp-windows.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ ip6tcp-windows.cpp

ip6tcp.so: ip6tcp-windows.o ../src/libinstantsend-plugin.dll ../src/libinstantsend-json.dll
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ ip6tcp-windows.o -L../src/ -linstantsend-json -linstantsend-plugin -lwsock32 $(LDFLAGS)

ip6tcp.dll: ../include/pluginapi.h ip6tcp-windows.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ ip6tcp-windows.cpp $(LDFLAGS) -lwsock32

zenityprogress.so: zenityprogress.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ zenityprogress.cpp $(LDFLAGS)

dbus.so: dbus.cpp
	$(CXX) $(CXXFLAGS) $(DBUS_CFLAGS) $(DEFS) -o $@ dbus.cpp $(LDFLAGS) $(DBUS_LIBS)

desktop-notify.so: desktop-notify.cpp
	$(CXX) $(CXXFLAGS) $(NOTIFY_CFLAGS) $(DEFS) -o $@ desktop-notify.cpp $(LDFLAGS) $(NOTIFY_LIBS)

avahi-publish.so: avahi-publish.cpp
	$(CXX) $(CXXFLAGS) $(AVAHI_CFLAGS) $(DEFS) -o $@ avahi-publish.cpp $(LDFLAGS) $(AVAHI_LIBS)

check:

clean:
	rm -f *.so

distclean: clean
	rm -f Makefile

install:
	mkdir -p $(DESTDIR)$(LIBDIR)/instantsend/plugins
	cp *.so $(DESTDIR)$(LIBDIR)/instantsend/plugins

.PHONY: all check clean distclean install

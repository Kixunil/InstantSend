CXXFLAGS=@CXXFLAGS@
CXXFLAGS+=-I../include -I. -I../
DEFS=@DEFS@
LDFLAGS=@LDFLAGS@ @LIBS@
SERVER_LDFLAGS=-ldl
CLIENT_CFLAGS=-ldl

prefix=@prefix@
PREFIX=$(prefix)
exec_prefix=@exec_prefix@
BINDIR=@bindir@
LIBDIR=@libdir@
datarootdir=@datarootdir@
DATADIR=@datadir@
LOCALEDIR=@localedir@

GETTEXT_DOMAINNAME=instantsend-dialog-gtk

DEFS+=-DPREFIX=\"$(PREFIX)\" -DBINDIR=\"$(BINDIR)\" -DLIBDIR=\"$(LIBDIR)\" -DDATADIR=\"$(DATADIR)\" -DGETTEXT_PACKAGE=\"$(GETTEXT_DOMAINNAME)\" -DLOCALEDIR=\"$(LOCALEDIR)\"

HAVE_CLIENT=@have_client@
HAVE_SERVER=@have_server@
HAVE_CONFIGTOOL=@have_configtool@
HAVE_WIDGET_GTK=@have_widget_gtk@

WIDGET_GTK_CFLAGS=@WIDGET_GTK_CFLAGS@
WIDGET_GTK_LIBS=@WIDGET_GTK_LIBS@

HOST=@host_alias@

CLIENT_BIN=$(DESTDIR)$(BINDIR)/isend # Short name for better user experience
SERVER_BIN=$(DESTDIR)$(BINDIR)/instsendd
CONFIGTOOL_BIN=$(DESTDIR)$(BINDIR)/instsend-config
WIDGET_GTK_BIN=$(DESTDIR)$(BINDIR)/instsend-dialog-gtk

ifndef OS
	OS=linux
	CLIENT_LDFLAGS+=-ldl -pthread -rdynamic
	SERVER_LDFLAGS+=-ldl -pthread -rdynamic
endif

ifeq ($(OS),windows)
	CXX=$(ARCH)-w64-mingw32-g++
	CXXFLAGS+=-I/usr/$(ARCH)-w64-mingw32/include/ -DWINDOWS
	EXTENSION=.exe
endif

ifeq ($(HOST),i686-linux-gnu)
	CFLAGS+=-march=i686 -m32
endif

ifeq ($(HOST),arm-linux-gnueabihf)
	CXX=arm-linux-gnueabihf-g++
endif

ifeq ($(HOST),arm-linux-gnueabi)
	CXX=arm-linux-gnueabi-g++
endif

ifeq ($(HAVE_CLIENT),yes)
	ALL+=client$(EXTENSION)
	INSTALL+=install-client
endif

ifeq ($(HAVE_SERVER),yes)
	ALL+=server$(EXTENSION)
	INSTALL+=install-server
endif

ifeq ($(HAVE_CONFIGTOOL),yes)
	ALL+=configtool$(EXTENSION)
	INSTALL+=install-configtool
endif

ifeq ($(HAVE_WIDGET_GTK),yes)
	ALL+=widget-gtk$(EXTENSION)
	INSTALL+=install-widget-gtk
endif

all: $(ALL)

client$(EXTENSION): json.o pluginloader.o pluginloader-platformdependent.o pluginlist.o plugin.o sysapi.o eventsink.o ../include/pluginapi.h client.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ json.o pluginloader-platformdependent.o pluginloader.o pluginlist.o plugin.o sysapi.o eventsink.o client.cpp $(LDFLAGS) $(CLIENT_LDFLAGS)

server$(EXTENSION): json.o pluginloader.o pluginloader-platformdependent.o pluginlist.o plugin.o sysapi.o multithread.o filewriter.o filelist.o eventsink.o datareceiver.o connectionreceiver.o appcontrol-platformdependent.o ../include/pluginapi.h server.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ json.o pluginloader-platformdependent.o pluginloader.o pluginlist.o plugin.o sysapi.o multithread.o filewriter.o filelist.o eventsink.o datareceiver.o connectionreceiver.o appcontrol-platformdependent.o server.cpp $(LDFLAGS) $(SERVER_LDFLAGS)

widget-gtk: json.o sysapi.o multithread.o widget-gtk.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) $(WIDGET_GTK_CFLAGS) -o $@ widget-gtk.cpp json.o sysapi.o multithread.o $(WIDGET_GTK_LIBS)

configtool: configtool.cpp json.o sysapi.o
	$(CXX) $(CXXFLAGS) $(DEFS) -o $@ json.o sysapi.o configtool.cpp

libinstantsend.o: libinstantsend.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ libinstantsend.cpp

json.o: json.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ json.cpp

pluginlist.o: pluginlist.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ pluginlist.cpp

plugin.o: plugin.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ plugin.cpp

environment.o: sysapi/$(OS)/environment.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ sysapi/$(OS)/environment.cpp

pluginloader.o: pluginloader.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ pluginloader.cpp

pluginloader-platformdependent.o: sysapi/$(OS)/pluginloader-$(OS).cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ sysapi/$(OS)/pluginloader-$(OS).cpp

sysapi.o: sysapi/$(OS)/misc.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ sysapi/$(OS)/misc.cpp

multithread.o: sysapi/$(OS)/multithread.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) $(LDFLAGS) -c -o $@ sysapi/$(OS)/multithread.cpp

filewriter.o: filewriter.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ filewriter.cpp

filelist.o: filelist.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ filelist.cpp

eventsink.o: eventsink.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ eventsink.cpp

datareceiver.o: datareceiver.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ datareceiver.cpp

connectionreceiver.o: connectionreceiver.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ connectionreceiver.cpp

appcontrol-platformdependent.o: sysapi/$(OS)/appcontrol-platformdependent.cpp
	$(CXX) $(CXXFLAGS) $(DEFS) -c -o $@ sysapi/$(OS)/appcontrol-platformdependent.cpp

check:

clean:
	rm -f *.o client$(EXTENSION) server$(EXTENSION) configtool$(EXTENSION) widget-gtk

distclean: clean
	rm -f Makefile

install-client: client
	install -D client $(CLIENT_BIN)

install-server: server
	install -D server $(SERVER_BIN)

install-configtool: configtool
	install -D configtool $(CONFIGTOOL_BIN)

install-widget-gtk: widget-gtk
	install -D widget-gtk $(WIDGET_GTK_BIN)

install: $(INSTALL)

.PHONY: all check clean distclean install install-client install-server install-configtool install-widget-gtk

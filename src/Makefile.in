CFLAGS+=-W -Wall -g -I../include -I. -I../ -DPREFIX=\"$(PREFIX)\"

PREFIX=@prefix@
HOST=@host_alias@

ifndef OS
	OS=linux
	LDFLAGS+=-ldl -pthread -rdynamic
endif

ifeq ($(OS),windows)
	CXX=$(ARCH)-w64-mingw32-g++
	CFLAGS+=-I/usr/$(ARCH)-w64-mingw32/include/ -DWINDOWS
	NOWIDGET=1
	EXTENSION=.exe
endif

ifeq ($(HOST),i686-linux-gnu)
	CFLAGS+=-march=i686 -m32
endif

ifeq ($(HOST),arm-linux-gnueabihf)
	CXX=arm-linux-gnueabihf-g++
endif

ifeq ($(HOST),arm-linux-gnueabi)
	CXX=arm-linux-gnueabi-g++
endif

all: client server configtool widget-gtk

client$(EXTENSION): json.o pluginloader.o pluginloader-platformdependent.o pluginlist.o plugin.o sysapi.o eventsink.o ../include/pluginapi.h client.cpp
	$(CXX) $(CFLAGS) -o $@ json.o pluginloader-platformdependent.o pluginloader.o pluginlist.o plugin.o sysapi.o eventsink.o client.cpp $(LDFLAGS)

server$(EXTENSION): json.o pluginloader.o pluginloader-platformdependent.o pluginlist.o plugin.o sysapi.o multithread.o filewriter.o filelist.o eventsink.o ../include/pluginapi.h server.cpp
	$(CXX) $(CFLAGS) -o $@ json.o pluginloader-platformdependent.o pluginloader.o pluginlist.o plugin.o sysapi.o multithread.o filewriter.o filelist.o eventsink.o server.cpp $(LDFLAGS)

widget-gtk: json.o sysapi.o widget-gtk.cpp
	if [ "$(NOWIDGET)" -eq 1 ]; then echo No widget support; touch widget-gtk; else $(CXX) $(CFLAGS) -o $@ widget-gtk.cpp json.o sysapi.o `pkg-config --cflags --libs gtkmm-2.4` `pkg-config --cflags --libs dbus-1`; fi

configtool: configtool.cpp json.o sysapi.o
	$(CXX) $(CFLAGS) -o $@ json.o sysapi.o configtool.cpp

libinstantsend.o: libinstantsend.cpp
	$(CXX) $(CFLAGS) -c -o $@ libinstantsend.cpp

json.o: json.cpp
	$(CXX) $(CFLAGS) -c -o $@ json.cpp

pluginlist.o: pluginlist.cpp
	$(CXX) $(CFLAGS) -c -o $@ pluginlist.cpp

plugin.o: plugin.cpp
	$(CXX) $(CFLAGS) -c -o $@ plugin.cpp

environment.o: sysapi/$(OS)/environment.cpp
	$(CXX) $(CFLAGS) -c -o $@ sysapi/$(OS)/environment.cpp

pluginloader.o: pluginloader.cpp
	$(CXX) $(CFLAGS) -c -o $@ pluginloader.cpp

pluginloader-platformdependent.o: sysapi/$(OS)/pluginloader-$(OS).cpp
	$(CXX) $(CFLAGS) -c -o $@ sysapi/$(OS)/pluginloader-$(OS).cpp

sysapi.o: sysapi/$(OS)/misc.cpp
	$(CXX) $(CFLAGS) -c -o $@ sysapi/$(OS)/misc.cpp

multithread.o: sysapi/$(OS)/multithread.cpp
	$(CXX) $(CFLAGS) $(LDFLAGS) -c -o $@ sysapi/$(OS)/multithread.cpp

filewriter.o: filewriter.cpp
	$(CXX) $(CFLAGS) -c -o $@ filewriter.cpp

filelist.o: filelist.cpp
	$(CXX) $(CFLAGS) -c -o $@ filelist.cpp

eventsink.o: eventsink.cpp
	$(CXX) $(CFLAGS) -c -o $@ eventsink.cpp

check:

clean:
	rm -f *.o client$(EXTENSION) server$(EXTENSION) configtool$(EXTENSION) widget-gtk

distclean: clean
	rm -f Makefile

install:
	mkdir -p $(DESTDIR)$(PREFIX)/bin
	cp server $(DESTDIR)$(PREFIX)/bin/instsendd
	cp client $(DESTDIR)$(PREFIX)/bin/isend # Short name for better user experience
	cp widget-gtk $(DESTDIR)$(PREFIX)/bin/instsend-dialog-gtk
	cp configtool $(DESTDIR)$(PREFIX)/bin/instsend-config
	chmod 755 $(DESTDIR)$(PREFIX)/bin/instsendd $(DESTDIR)$(PREFIX)/bin/isend $(DESTDIR)$(PREFIX)/bin/instsend-config $(DESTDIR)$(PREFIX)/bin/instsend-dialog-gtk

.PHONY: all check clean distclean install
